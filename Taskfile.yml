version: "3"

tasks:
  format-yaml:
    internal: true
    cmds:
      - npx prettier {{ .DIR }} --write

  format-node-configs:
    cmds:
      - task: format-yaml
        vars:
          DIR: ./cluster/main/talos/

  generate-node-configs:
    cmds:
      - talhelper genconfig

  bootstrap-talos-node:
    cmds:
      - talosctl bootstrap
        --talosconfig=./cluster/shared/talosconfig
        --insecure
        # --cluster highglade \
        # --nodes 10.30.0.160 \

  export-kubeconfig:
    internal: true
    cmds:
      - talosctl kubeconfig ./highglade-kubeconfig
        -n {{ .NODE }}
        -e {{ .NODE }}

  export-kubeconfig-s1:
    cmds:
      - task: export-kubeconfig
        vars:
          NODE: 10.30.0.161

  # Generic apply configuration command (reusable for multiple nodes)
  apply-config:
    internal: true
    cmds:
      - talosctl apply-config \
        -n {{ .NODE }} \
        -e {{ .ENDPOINT }} \
        -f {{ .CONFIG_FILE }} \
        --talosconfig ./clusterconfig/talosconfig \
        {{ .CLI_ARGS }}

  # Apply config for control plane nodes (sentinel-1, sentinel-2, sentinel-3)
  update-control-points:
    cmds:
      - task: apply-config
        vars:
          NODE: 10.30.0.161
          ENDPOINT: 10.30.0.161
          CONFIG_FILE: clusterconfig/highglade-cluster-sentinel-1.yaml
      - task: apply-config
        vars:
          NODE: 10.30.0.162
          ENDPOINT: 10.30.0.162
          CONFIG_FILE: clusterconfig/highglade-cluster-sentinel-2.yaml
      - task: apply-config
        vars:
          NODE: 10.30.0.163
          ENDPOINT: 10.30.0.163
          CONFIG_FILE: clusterconfig/highglade-cluster-sentinel-3.yaml
          #
  # Apply config for worker nodes (sentinel-4, sentinel-5, sentinel-6)
  update-workers:
    cmds:
      - task: apply-config {{ .CLI_ARGS }
        vars:
          NODE: 10.30.0.164
          ENDPOINT: 10.30.0.164
          CONFIG_FILE: clusterconfig/highglade-cluster-sentinel-4.yaml
      - task: apply-config
        vars:
          NODE: 10.30.0.165
          ENDPOINT: 10.30.0.165
          CONFIG_FILE: clusterconfig/highglade-cluster-sentinel-5.yaml
      - task: apply-config
        vars:
          NODE: 10.30.0.166
          ENDPOINT: 10.30.0.166
          CONFIG_FILE: clusterconfig/highglade-cluster-sentinel-6.yaml

  try-all:
    cmds:
      - task: update-control-points --mode=try
      - task: update-workers --mode=try

  update-all:
    cmds:
      - task: update-control-points
      - task: update-workers

  install-helm-repos:
    cmds:
      - helm repo add traefik https://traefik.github.io/charts

  deploy-traefik:
    cmds:
      - helm template traefik traefik/traefik > ./kustomize/apps/traefik/base/traefik-manifests.yaml
      - helm template traefik traefik/traefik-crds > ./kustomize/apps/traefik/base/traefik-crds-manifests.yaml
      - kubectl kustomize ./kustomize/apps/traefik/overlay/prod | kubectl apply -f -
